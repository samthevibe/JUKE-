<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>JUKE ‚Äî Player</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding-bottom:150px;background:#f6f6f8}
    header{padding:14px;text-align:center}
    .grid{display:flex;flex-wrap:wrap;gap:18px;padding:18px;justify-content:center}
    .card{width:220px;background:#fff;border-radius:10px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);display:flex;flex-direction:column;align-items:center}
    .card img{width:180px;height:180px;object-fit:cover;border-radius:6px}
    .card h3{font-size:16px;margin:8px 0 4px}
    .card p{font-size:12px;margin:0;color:#666}
    .tracks{width:100%;margin-top:8px}
    .track{display:flex;justify-content:space-between;font-size:13px;padding:6px 0;border-top:1px solid #eee}
    .controls{position:fixed;bottom:0;left:0;width:100%;background:#111;color:#fff;padding:10px;display:flex;align-items:center;gap:12px}
    .searchBar{position:fixed;bottom:120px;left:0;width:100%;display:flex;justify-content:center}
    .searchBar input{width:60%;padding:10px;border-radius:8px;border:1px solid #ddd}
    button.playBtn{background:#1db954;border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}
    .queue{max-height:80px;overflow:auto;color:#ddd;margin-left:10px}
    .playerInfo{min-width:220px}
    .progress{width:100%;height:6px;background:#333;border-radius:3px;margin-top:6px}
    .progress > span{display:block;height:100%;background:#1db954;width:0;border-radius:3px}
  </style>
</head>
<body>
  <header><h1>JUKE</h1><a href="/add" style="text-decoration:none;color:#333">Add Album</a></header>

  <div class="searchBar">
    <input id="search" placeholder="Search albums, artists or tracks..." oninput="liveSuggest()" />
  </div>

  <div id="mainGrid" class="grid"></div>

  <div class="controls">
    <div class="playerInfo">
      <div id="now">No track</div>
      <div class="progress"><span id="prog"></span></div>
    </div>

    <div>
      <button onclick="prev()">‚èÆÔ∏è</button>
      <button onclick="togglePlay()">‚ñ∂Ô∏è/‚è∏Ô∏è</button>
      <button onclick="next()">‚è≠Ô∏è</button>
    </div>

    <div style="margin-left:auto;display:flex;align-items:center;">
      <div>üîä</div>
      <input id="volume" type="range" min="0" max="1" step="0.01" value="1" style="margin:0 8px" />
      <div style="color:#ddd">Shuffle <input id="shuffle" type="checkbox" /></div>
      <div style="color:#ddd;margin-left:10px">Repeat <input id="repeat" type="checkbox" /></div>
    </div>

    <div style="width:260px;margin-left:10px">
      <div style="color:#ddd">Queue</div>
      <div id="queue" class="queue"></div>
    </div>
  </div>

  <audio id="audio"></audio>

<script>
  const api = { albums: '/api/albums', search: '/api/search', trending: '/api/trending', recent:'/api/recent' };
  let albums = [];
  let queue = [];
  let idx = -1;
  const audio = document.getElementById('audio');
  const progBar = document.getElementById('prog');
  const now = document.getElementById('now');

  async function loadAll() {
    const res = await fetch(api.albums);
    albums = await res.json();
    renderGrid(albums);
  }

  function renderGrid(list) {
    const grid = document.getElementById('mainGrid');
    grid.innerHTML = '';
    list.forEach(a=>{
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        ${a.coverUrl ? '<img src="'+a.coverUrl+'"/>' : '<div style="width:180px;height:180px;background:#ddd;border-radius:6px"></div>'}
        <h3>${a.title}</h3>
        <p>${a.artist}</p>
        <div class="tracks">${a.tracks.map(t=>'<div class="track"><div>'+t.title+'</div><div><button class="playBtn" onclick="addToQueue(\\''+escapeHtml(t.title)+'\\',\\''+t.file+'\\')">Play</button> <button onclick="streamTrack('+a.id+','+t.id+')">Stream</button></div></div>').join('')}</div>
      `;
      grid.appendChild(div);
    });
  }

  function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // search
  let searchTimer = null;
  function liveSuggest(){
    clearTimeout(searchTimer);
    searchTimer = setTimeout(()=> {
      const q = document.getElementById('search').value;
      fetch('/api/search?q='+encodeURIComponent(q)).then(r=>r.json()).then(renderGrid);
    }, 220);
  }

  // QUEUE / PLAYER
  function addToQueue(title, file) {
    if(!file) { alert('No audio file attached for this track'); return; }
    queue.push({ title, file });
    renderQueue();
    if(idx === -1) playAt(0);
  }

  function renderQueue(){
    const qd = document.getElementById('queue');
    qd.innerHTML = queue.map((t,i)=>'<div style="color:'+ (i===idx? '#1db954':'#ddd') +'">'+(i+1)+'. '+t.title+'</div>').join('');
  }

  function playAt(i){
    if(i<0||i>=queue.length) return;
    idx = i;
    audio.src = '/uploads/' + queue[i].file;
    audio.play();
    now.textContent = 'Now playing: ' + queue[i].title;
    renderQueue();
  }

  function togglePlay(){ if(audio.paused) audio.play(); else audio.pause(); }
  function next(){
    if(document.getElementById('shuffle').checked){
      const r = Math.floor(Math.random()*queue.length);
      playAt(r);
    } else {
      if(idx < queue.length-1) playAt(idx+1);
      else if(document.getElementById('repeat').checked) playAt(0);
    }
  }
  function prev(){ if(idx>0) playAt(idx-1); }

  audio.ontimeupdate = () => {
    if(!audio.duration || !audio.currentTime) progBar.style.width = '0%';
    else progBar.style.width = (audio.currentTime / audio.duration * 100) + '%';
    if(audio.ended) next();
  };
  document.getElementById('volume').oninput = (e)=> audio.volume = e.target.value;

  // streaming counters
  function streamTrack(albumId, trackId){
    fetch('/api/albums/'+albumId+'/tracks/'+trackId+'/stream',{method:'POST'}).then(()=>loadAll());
  }
  function streamAlbum(albumId){
    fetch('/api/albums/'+albumId+'/stream',{method:'POST'}).then(()=>loadAll());
  }

  // playlists (basic)
  async function createPlaylist(name){
    await fetch('/api/playlists', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name})});
    alert('Playlist created');
  }

  loadAll();
</script>
</body>
</html>
